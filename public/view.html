<!DOCTYPE html>
<html lang="id" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yuii Translator</title>
    <link rel="shortcut icon" href="https://ucarecdn.com/ebe81342-64fc-4e47-bcc5-632c0552c657/11zon_cropped.png"
        type="image/x-icon">
    <link rel="manifest" href="/manifest">
    <meta name="theme-color" content="#1a1b26">
    <link rel="apple-touch-icon" href="https://ucarecdn.com/ebe81342-64fc-4e47-bcc5-632c0552c657/11zon_cropped.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        tokyo: {
                            base: '#1a1b26',
                            surface: '#24283b',
                            primary: '#7aa2f7',
                            secondary: '#bb9af7',
                            accent: '#7dcfff',
                            success: '#9ece6a',
                            warning: '#e0af68',
                            error: '#f7768e',
                            text: '#c0caf5',
                            muted: '#565f89'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            transition: background-color 0.3s ease, color 0.3s ease;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 768px) {
            .bento-card {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .bento-card:hover {
                transform: translateY(-2px);
            }
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #565f89;
            border-radius: 20px;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                box-shadow: 0 0 0 0 rgba(247, 118, 142, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(247, 118, 142, 0);
            }

            100% {
                transform: scale(0.8);
                box-shadow: 0 0 0 0 rgba(247, 118, 142, 0);
            }
        }

        .recording-pulse {
            animation: pulse-ring 2s infinite;
        }

        .touch-manipulation {
            touch-action: manipulation;
        }
    </style>
</head>

<body
    class="bg-gray-50 text-gray-800 dark:bg-tokyo-base dark:text-tokyo-text font-sans min-h-[100dvh] flex flex-col selection:bg-blue-500 selection:text-white">

    <main class="flex-1 w-full max-w-7xl mx-auto p-4 md:p-6 lg:p-8 flex flex-col justify-center">

        <header class="flex items-center justify-between mb-6 md:mb-8">
            <div>
                <h1
                    class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 dark:from-tokyo-primary dark:to-tokyo-secondary tracking-tight">
                    Basic Translation
                </h1>
            </div>

            <div class="flex items-center gap-2 md:gap-3">
                <button id="urgentBtn"
                    class="touch-manipulation h-10 px-3 md:px-4 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 border border-gray-200 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors flex items-center gap-2 text-xs md:text-sm font-medium">
                    <i class="fas fa-bug"></i>
                    <span>Report</span>
                </button>

                <button id="themeToggle"
                    class="touch-manipulation p-2 rounded-full bg-white dark:bg-tokyo-surface shadow-sm border border-gray-200 dark:border-gray-700 w-10 h-10 flex items-center justify-center transition-colors">
                    <i id="themeIcon" class="fas fa-sun text-orange-400 text-lg"></i>
                </button>
            </div>

            <div id="urgentModal"
                class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex-col items-center justify-center p-4 opacity-0 transition-opacity duration-300">
                <div class="bg-white dark:bg-tokyo-surface w-full max-w-sm rounded-3xl p-6 shadow-2xl border border-gray-200 dark:border-gray-700 transform scale-95 transition-transform duration-300"
                    id="urgentContent">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white">Report bug</h3>
                        <button id="closeUrgentBtn" class="text-gray-400 hover:text-gray-600 dark:hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <input type="text" id="urgentName"
                        class="w-full bg-gray-50 dark:bg-[#1f2335] rounded-xl p-4 text-gray-700 dark:text-tokyo-text border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-red-400 outline-none mb-3 text-sm"
                        placeholder="Your Name">

                    <textarea id="urgentMessage" rows="4"
                        class="w-full bg-gray-50 dark:bg-[#1f2335] rounded-xl p-4 text-gray-700 dark:text-tokyo-text border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-red-400 outline-none resize-none mb-4 text-sm"
                        placeholder="Write error or bug report (e.g. API failure, design glitch)..."></textarea>

                    <button id="sendIgBtn"
                        class="w-full py-3 rounded-xl bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white font-bold shadow-lg shadow-pink-500/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <i class="fab fa-instagram text-lg"></i>
                        <span>Kirim ke Instagram</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 relative">

            <div
                class="col-span-1 md:col-span-6 bg-white dark:bg-tokyo-surface rounded-2xl md:rounded-3xl shadow-sm md:shadow-lg border border-gray-200 dark:border-gray-800 flex flex-col h-auto min-h-[220px] md:h-[400px] relative z-0">

                <div
                    class="flex items-center justify-between p-3 md:p-4 border-b border-gray-100 dark:border-gray-700/50">
                    <div class="relative w-1/2">
                        <select id="fromLang"
                            class="w-full bg-gray-50 dark:bg-[#1f2335] text-gray-800 dark:text-tokyo-primary font-semibold py-2 pl-3 pr-8 rounded-lg text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-blue-400/50 transition-shadow">
                            <option value="id">ðŸ‡®ðŸ‡© Indonesia</option>
                            <option value="en">ðŸ‡ºðŸ‡¸ English</option>
                            <option value="ja">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
                            <option value="zh">ðŸ‡¨ðŸ‡³ Mandarin</option>
                            <option value="ko">ðŸ‡°ðŸ‡· Korean</option>
                            <option value="my">ðŸ‡²ðŸ‡² Myanmar</option>
                            <option value="th">ðŸ‡¹ðŸ‡­ Thailand</option>
                            <option value="tl">ðŸ‡µðŸ‡­ Philippines</option>
                            <option value="fr">ðŸ‡«ðŸ‡· French</option>
                        </select>
                        <i
                            class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
                    </div>

                    <div class="flex gap-1">
                        <button id="voiceBtn"
                            class="touch-manipulation w-10 h-10 md:w-9 md:h-9 rounded-full flex items-center justify-center text-gray-500 dark:text-tokyo-muted hover:bg-blue-50 dark:hover:bg-gray-700/30 hover:text-blue-500 transition-colors active:scale-95">
                            <i class="fas fa-microphone text-lg md:text-base"></i>
                        </button>
                        <button id="clearBtn"
                            class="touch-manipulation w-10 h-10 md:w-9 md:h-9 rounded-full flex items-center justify-center text-gray-500 dark:text-tokyo-muted hover:bg-red-50 dark:hover:bg-gray-700/30 hover:text-red-500 transition-colors active:scale-95">
                            <i class="fas fa-trash-alt text-lg md:text-base"></i>
                        </button>
                    </div>
                </div>

                <div class="flex-1 p-3 md:p-4 relative">
                    <textarea id="inputText"
                        class="w-full h-full bg-transparent border-none focus:ring-0 resize-none text-base md:text-lg leading-relaxed text-gray-700 dark:text-tokyo-text placeholder-gray-400 dark:placeholder-tokyo-muted/50 custom-scroll outline-none pb-6"
                        placeholder="Your text...." maxlength="5000"></textarea>
                    <div class="absolute bottom-2 right-3 text-[10px] md:text-xs text-gray-400 dark:text-tokyo-muted font-mono"
                        id="charCount">0/5000</div>
                </div>
            </div>

            <div class="col-span-1 md:hidden flex justify-center -my-5 relative z-10 pointer-events-none">
                <button id="swapBtnMobile"
                    class="pointer-events-auto w-12 h-12 bg-blue-600 dark:bg-tokyo-primary text-white rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center active:scale-90 transition-transform touch-manipulation border-4 border-gray-50 dark:border-tokyo-base">
                    <i class="fas fa-exchange-alt transform rotate-90 text-lg"></i>
                </button>
            </div>

            <div class="hidden md:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10">
                <button id="swapBtn"
                    class="w-10 h-10 bg-blue-600 dark:bg-tokyo-primary text-white rounded-xl shadow-lg hover:scale-110 active:scale-95 transition-all flex items-center justify-center border-4 border-gray-50 dark:border-tokyo-base">
                    <i class="fas fa-exchange-alt"></i>
                </button>
            </div>

            <div
                class="col-span-1 md:col-span-6 bg-gray-100 dark:bg-[#1f2335] rounded-2xl md:rounded-3xl shadow-inner border border-transparent dark:border-gray-800 flex flex-col h-auto min-h-[220px] md:h-[400px]">

                <div
                    class="flex items-center justify-between p-3 md:p-4 border-b border-gray-200 dark:border-gray-700/50">
                    <div class="relative w-1/2">
                        <select id="toLang"
                            class="w-full bg-white dark:bg-tokyo-surface text-gray-800 dark:text-tokyo-secondary font-semibold py-2 pl-3 pr-8 rounded-lg text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-purple-400/50 shadow-sm transition-shadow">
                            <option value="en">ðŸ‡ºðŸ‡¸ English</option>
                            <option value="id">ðŸ‡®ðŸ‡© Indonesia</option>
                            <option value="ja">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
                            <option value="zh">ðŸ‡¨ðŸ‡³ Mandarin</option>
                            <option value="ko">ðŸ‡°ðŸ‡· Korean</option>
                            <option value="my">ðŸ‡²ðŸ‡² Myanmar</option>
                            <option value="th">ðŸ‡¹ðŸ‡­ Thailand</option>
                            <option value="tl">ðŸ‡µðŸ‡­ Philippines</option>
                            <option value="fr">ðŸ‡«ðŸ‡· French</option>
                        </select>
                        <i
                            class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
                    </div>

                    <div class="flex gap-1">
                        <button id="speakBtn"
                            class="touch-manipulation w-10 h-10 md:w-9 md:h-9 rounded-full flex items-center justify-center text-gray-500 dark:text-tokyo-muted hover:bg-white dark:hover:bg-gray-700/30 hover:text-purple-500 transition-colors active:scale-95 disabled:opacity-30"
                            disabled>
                            <i class="fas fa-volume-up text-lg md:text-base"></i>
                        </button>
                        <button id="copyBtn"
                            class="touch-manipulation w-10 h-10 md:w-9 md:h-9 rounded-full flex items-center justify-center text-gray-500 dark:text-tokyo-muted hover:bg-white dark:hover:bg-gray-700/30 hover:text-green-500 transition-colors active:scale-95 disabled:opacity-30"
                            disabled>
                            <i class="fas fa-copy text-lg md:text-base"></i>
                        </button>
                    </div>
                </div>

                <div class="flex-1 p-4 flex items-start relative">
                    <div id="loadingIndicator"
                        class="hidden absolute inset-0 bg-gray-100/80 dark:bg-[#1f2335]/80 backdrop-blur-[1px] z-20 items-center justify-center rounded-b-2xl">
                        <div class="flex flex-col items-center">
                            <svg class="animate-spin h-8 w-8 text-purple-600 dark:text-tokyo-secondary mb-2"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span class="text-xs font-medium text-gray-500 dark:text-tokyo-muted">Translating...</span>
                        </div>
                    </div>

                    <div id="outputText"
                        class="w-full h-full text-base md:text-lg leading-relaxed text-gray-600 dark:text-tokyo-text/90 custom-scroll overflow-y-auto break-words pb-2">
                        <span class="text-gray-400 dark:text-tokyo-muted/40 italic">Your translation here....</span>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="voiceIndicator"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex-col items-center justify-center p-4 transition-opacity">
        <div
            class="bg-white dark:bg-tokyo-surface p-8 rounded-3xl shadow-2xl flex flex-col items-center max-w-xs w-full border border-gray-200 dark:border-gray-700">
            <div
                class="w-24 h-24 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mb-6 recording-pulse">
                <i class="fas fa-microphone text-4xl text-red-500 dark:text-tokyo-error"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Mendengarkan...</h3>
            <p class="text-gray-500 dark:text-tokyo-muted text-sm text-center mb-8">Bicara sekarang</p>
            <button id="stopVoiceBtn"
                class="w-full py-3 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white font-medium hover:bg-gray-300 transition-colors">
                Batal
            </button>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-8 left-1/2 -translate-x-1/2 transform translate-y-24 opacity-0 transition-all duration-300 z-50 w-max max-w-[90%]">
        <div
            class="bg-gray-900/90 dark:bg-tokyo-primary/90 backdrop-blur-sm text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3 border border-white/10">
            <i class="fas fa-check-circle text-green-400"></i>
            <span id="toastMessage" class="font-medium text-sm truncate">Berhasil!</span>
        </div>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw').catch(console.error);
            });
        }

        const urgentBtn = document.getElementById('urgentBtn');
    const urgentModal = document.getElementById('urgentModal');
    const urgentContent = document.getElementById('urgentContent');
    const closeUrgentBtn = document.getElementById('closeUrgentBtn');
    // ID diganti sesuai HTML baru
    const sendIgBtn = document.getElementById('sendIgBtn'); 
    const urgentMessage = document.getElementById('urgentMessage');
    const urgentName = document.getElementById('urgentName'); // Pastikan variabel ini ada

    // Link Instagram DM Anda
    const IG_LINK = 'https://ig.me/m/yuii__chi';

    function toggleUrgentModal(show) {
        if (show) {
            urgentModal.classList.remove('hidden', 'flex');
            urgentModal.classList.add('flex');
            setTimeout(() => {
                urgentModal.classList.remove('opacity-0');
                urgentContent.classList.remove('scale-95');
                urgentContent.classList.add('scale-100');
            }, 10);
        } else {
            urgentModal.classList.add('opacity-0');
            urgentContent.classList.remove('scale-100');
            urgentContent.classList.add('scale-95');
            setTimeout(() => {
                urgentModal.classList.add('hidden');
                urgentModal.classList.remove('flex');
            }, 300);
        }
    }

    urgentBtn.addEventListener('click', () => toggleUrgentModal(true));
    closeUrgentBtn.addEventListener('click', () => toggleUrgentModal(false));

    urgentModal.addEventListener('click', (e) => {
        if (e.target === urgentModal) toggleUrgentModal(false);
    });

    // LOGIKA BARU: COPY TEXT + BUKA INSTAGRAM
    if (sendIgBtn) {
        sendIgBtn.addEventListener('click', async () => {
            const name = urgentName.value.trim() || 'Pengguna';
            const text = urgentMessage.value.trim();

            if (!text) {
                alert('Mohon isi detail bug/error!');
                return;
            }

            // Format Pesan
            const message = `[Bug Report Honyaku]\n\nNama: ${name}\nLaporan: ${text}`;

            try {
                // 1. Copy pesan ke clipboard user otomatis
                await navigator.clipboard.writeText(message);
                
                // 3. Buka Link Instagram
                window.open(IG_LINK, '_blank');
            } catch (err) {
                console.error('Gagal menyalin text', err);
                // Fallback jika copy gagal, tetap buka IG
                window.open(IG_LINK, '_blank');
            }

            // Tutup modal dan bersihkan form
            toggleUrgentModal(false);
            urgentMessage.value = '';
            urgentName.value = '';
        });
    }
    </script>
    <script>
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const html = document.documentElement;

        function initTheme() {
            const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            setDark(isDark);
        }

        function setDark(isDark) {
            if (isDark) {
                html.classList.add('dark');
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                themeIcon.classList.replace('text-orange-400', 'text-indigo-300');
                localStorage.theme = 'dark';
            } else {
                html.classList.remove('dark');
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                themeIcon.classList.replace('text-indigo-300', 'text-orange-400');
                localStorage.theme = 'light';
            }
        }

        themeToggle.addEventListener('click', () => setDark(!html.classList.contains('dark')));
        initTheme();

        class TranslatorApp {
            constructor() {
                this.initializeElements();
                this.attachEventListeners();
                this.setupSpeechRecognition();
                this.isSpeaking = false;
                this.typingTimer = null; // Timer untuk debounce
            }

            initializeElements() {
                this.elements = {
                    fromLang: document.getElementById('fromLang'),
                    toLang: document.getElementById('toLang'),
                    swapBtn: document.getElementById('swapBtn'),
                    swapBtnMobile: document.getElementById('swapBtnMobile'),
                    inputText: document.getElementById('inputText'),
                    outputText: document.getElementById('outputText'),
                    // translateBtn removed
                    voiceBtn: document.getElementById('voiceBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    copyBtn: document.getElementById('copyBtn'),
                    speakBtn: document.getElementById('speakBtn'),
                    charCount: document.getElementById('charCount'),
                    voiceIndicator: document.getElementById('voiceIndicator'),
                    stopVoiceBtn: document.getElementById('stopVoiceBtn'),
                    loadingIndicator: document.getElementById('loadingIndicator'),
                    toast: document.getElementById('toast'),
                    toastMessage: document.getElementById('toastMessage')
                };
            }

            attachEventListeners() {
                // Auto translate event listener
                this.elements.inputText.addEventListener('input', () => {
                    this.updateCharCount();

                    // Clear previous timer
                    clearTimeout(this.typingTimer);

                    // Logic Auto Translate
                    if (this.elements.inputText.value.trim()) {
                        // Set timer baru: 1000ms (1 detik) setelah berhenti mengetik akan trigger translate
                        this.typingTimer = setTimeout(() => {
                            this.translateText();
                        }, 1000);
                    } else {
                        // Jika input kosong, reset tampilan segera
                        this.elements.outputText.innerHTML = '<span class="text-gray-400 dark:text-tokyo-muted/40 italic">Your translation....</span>';
                        this.elements.copyBtn.disabled = true;
                        this.elements.speakBtn.disabled = true;
                    }
                });

                const swapHandler = () => this.swapLanguages();
                if (this.elements.swapBtn) this.elements.swapBtn.addEventListener('click', swapHandler);
                if (this.elements.swapBtnMobile) this.elements.swapBtnMobile.addEventListener('click', swapHandler);

                this.elements.voiceBtn.addEventListener('click', () => this.startVoiceRecognition());
                this.elements.stopVoiceBtn.addEventListener('click', () => this.stopVoiceRecognition());
                this.elements.clearBtn.addEventListener('click', () => this.clearText());
                this.elements.copyBtn.addEventListener('click', () => this.copyResult());
                this.elements.speakBtn.addEventListener('click', () => this.toggleSpeech());
            }

            setupSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;
                    this.recognition.onstart = () => this.showVoiceIndicator();
                    this.recognition.onresult = (event) => {
                        let final = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) final += event.results[i][0].transcript;
                        }
                        if (final) {
                            this.elements.inputText.value = final;
                            this.updateCharCount();
                        }
                    };
                    this.recognition.onerror = (e) => {
                        this.showToast('Error: ' + e.error, 'error');
                        this.hideVoiceIndicator();
                    };
                    this.recognition.onend = () => {
                        this.hideVoiceIndicator();
                        if (this.elements.inputText.value.trim()) setTimeout(() => this.translateText(), 500);
                    };
                } else {
                    this.elements.voiceBtn.style.display = 'none';
                }
            }

            async translateText() {
                const text = this.elements.inputText.value.trim();
                // Jika kosong, abaikan saja (jangan tampilkan error toast untuk auto-translate agar tidak mengganggu)
                if (!text) return;

                this.showLoading();

                try {
                    const response = await fetch('/api/jisho', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            fromLang: this.elements.fromLang.value,
                            toLang: this.elements.toLang.value
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Gagal');

                    // TAMPILAN ALA GOOGLE TRANSLATE
                    if (data.transliteration) {
                        this.elements.outputText.innerHTML = `
                            <div class="flex flex-col justify-start h-full gap-1">
                                <div class="text-2xl font-medium text-gray-800 dark:text-white mb-1 leading-relaxed">
                                    ${data.translatedText}
                                </div>
                                
                                <div class="text-md text-gray-500 dark:text-gray-400 font-mono bg-gray-100 dark:bg-gray-800/50 px-3 py-2 rounded-lg w-fit">
                                    ${data.transliteration}
                                </div>
                            </div>
                        `;
                        // Simpan untuk TTS
                        this.elements.outputText.dataset.reading = data.transliteration;
                        this.elements.outputText.dataset.raw = data.translatedText;
                    } else {
                        // Tampilan Biasa
                        this.elements.outputText.textContent = data.translatedText;
                        this.elements.outputText.removeAttribute('data-reading');
                        this.elements.outputText.removeAttribute('data-raw');
                    }

                    this.elements.outputText.classList.remove('italic', 'text-gray-400');
                    this.elements.copyBtn.disabled = false;
                    this.elements.speakBtn.disabled = false;

                } catch (error) {
                    this.showToast(error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            }

            toggleSpeech() {
                if (this.isSpeaking) {
                    window.speechSynthesis.cancel();
                    this.isSpeaking = false;
                    this.elements.speakBtn.classList.remove('text-purple-500', 'animate-pulse');
                } else {
                    // Ambil teks: Prioritaskan cara baca (transliterasi) jika ada, baru teks asli
                    const transliteration = this.elements.outputText.dataset.reading;

                    // Untuk copy clipboard kita ambil raw, tapi untuk suara kita cek dulu
                    let textToSpeak = this.elements.outputText.textContent;

                    // Jika ada dataset raw, berarti struktur HTML berubah (ada transliterasi)
                    if (this.elements.outputText.dataset.raw) {
                        textToSpeak = this.elements.outputText.dataset.raw;
                    }

                    if (!textToSpeak && !transliteration) return;

                    const targetLang = this.elements.toLang.value;

                    // --- LOGIKA PENTING: PEMILIHAN SUARA ---
                    let langToUse = 'en-US'; // Default fallback
                    let textFinal = textToSpeak;

                    const difficultLangs = ['my', 'th', 'km', 'lo']; // Myanmar, Thai, Khmer, Lao

                    if (difficultLangs.includes(targetLang) && transliteration) {
                        // Kasus Khusus: Baca Latin-nya
                        textFinal = transliteration;
                        langToUse = 'id-ID'; // Gunakan aksen Indonesia karena pelafalan latinnya jelas
                    } else {
                        // Kasus Normal: Baca teks asli sesuai kode bahasa
                        textFinal = textToSpeak;
                        const langMap = {
                            'id': 'id-ID', 'en': 'en-US', 'ja': 'ja-JP', 'zh': 'zh-CN', 'ko': 'ko-KR',
                            'fr': 'fr-FR', 'tl': 'fil-PH'
                        };
                        langToUse = langMap[targetLang] || 'en-US';
                    }
                    // update
                    const utterance = new SpeechSynthesisUtterance(textFinal);
                    utterance.lang = langToUse;
                    utterance.rate = 0.7; // Sedikit diperlambat agar jelas

                    utterance.onend = () => {
                        this.isSpeaking = false;
                        this.elements.speakBtn.classList.remove('text-purple-500', 'animate-pulse');
                    };

                    // Error handler jika bahasa tidak didukung browser sama sekali
                    utterance.onerror = (e) => {
                        console.log("TTS Error:", e);
                        this.isSpeaking = false;
                        this.elements.speakBtn.classList.remove('text-purple-500', 'animate-pulse');
                    };

                    this.elements.speakBtn.classList.add('text-purple-500', 'animate-pulse');
                    this.isSpeaking = true;
                    window.speechSynthesis.speak(utterance);
                }
            }

            async copyResult() {
                // Prioritaskan mengambil teks asli (raw) jika tersedia di dataset
                const text = this.elements.outputText.dataset.raw || this.elements.outputText.textContent;

                if (!text) return;
                try {
                    await navigator.clipboard.writeText(text);
                    this.showToast('Teks disalin!');
                } catch (err) { this.showToast('Gagal menyalin', 'error'); }
            }
            swapLanguages() {
                const from = this.elements.fromLang.value;
                const to = this.elements.toLang.value;
                this.elements.fromLang.value = to;
                this.elements.toLang.value = from;

                const input = this.elements.inputText.value;
                const output = this.elements.outputText.textContent;

                if (output && !output.includes('Your translation')) {
                    this.elements.inputText.value = output;
                    this.elements.outputText.textContent = input;
                }

                const btns = [this.elements.swapBtn, this.elements.swapBtnMobile];
                btns.forEach(btn => {
                    if (btn) {
                        btn.classList.add('rotate-180');
                        setTimeout(() => btn.classList.remove('rotate-180'), 300);
                    }
                });
            }

            startVoiceRecognition() {
                if (!this.recognition) return;
                const langMap = {
                    'id': 'id-ID', 'en': 'en-US', 'ja': 'ja-JP', 'zh': 'zh-CN', 'ko': 'ko-KR',
                    'my': 'my-MM', 'th': 'th-TH', 'tl': 'tl-PH', 'fr': 'fr-FR'
                };
                this.recognition.lang = langMap[this.elements.fromLang.value] || 'en-US';
                this.recognition.start();
            }

            stopVoiceRecognition() {
                if (this.recognition) this.recognition.stop();
            }

            clearText() {
                this.elements.inputText.value = '';
                this.elements.outputText.innerHTML = '<span class="text-gray-400 dark:text-tokyo-muted/40 italic">Your translation here..</span>';
                this.elements.copyBtn.disabled = true;
                this.elements.speakBtn.disabled = true;
                this.updateCharCount();
            }


            updateCharCount() {
                const len = this.elements.inputText.value.length;
                this.elements.charCount.textContent = `${len}/5000`;
            }

            showVoiceIndicator() {
                this.elements.voiceIndicator.classList.remove('hidden');
                this.elements.voiceIndicator.classList.add('flex');
            }

            hideVoiceIndicator() {
                this.elements.voiceIndicator.classList.add('hidden');
                this.elements.voiceIndicator.classList.remove('flex');
            }

            showLoading() {
                this.elements.loadingIndicator.classList.remove('hidden');
                this.elements.loadingIndicator.classList.add('flex');
            }

            hideLoading() {
                this.elements.loadingIndicator.classList.add('hidden');
                this.elements.loadingIndicator.classList.remove('flex');
            }

            showToast(msg, type = 'success') {
                const toast = this.elements.toast;
                const txt = this.elements.toastMessage;
                txt.textContent = msg;

                if (type === 'error') toast.querySelector('i').className = 'fas fa-exclamation-circle text-red-400';
                else toast.querySelector('i').className = 'fas fa-check-circle text-green-400';

                toast.classList.remove('translate-y-24', 'opacity-0');
                setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => new TranslatorApp());
    </script>
</body>

</html>