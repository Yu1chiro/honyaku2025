<!DOCTYPE html><html lang="id" class="light"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Conversation</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet"><script>tailwind.config={darkMode:"class",theme:{extend:{fontFamily:{sans:["Inter","sans-serif"],serif:["Lora","serif"]},colors:{notion:{bg:"#FFFFFF",darkBg:"#191919",sidebar:"#F7F7F5",darkSidebar:"#202020",text:"#37352F",darkText:"#D4D4D4",border:"#E9E9E7",darkBorder:"#2F3437",hover:"#EFEFEF",darkHover:"#2C2C2C"}},boxShadow:{notion:"0 1px 3px rgba(0,0,0,0.05)","notion-modal":"0 8px 30px rgba(0,0,0,0.12)"}}}};</script><style>body{font-family:Inter,sans-serif;color:#37352f}.dark body{color:#d4d4d4}.recording-pulse{animation:pulse-ring 1.5s cubic-bezier(.4,0,.6,1) infinite}@keyframes pulse-ring{0%{box-shadow:0 0 0 0 rgba(235,87,87,.4)}70%{box-shadow:0 0 0 10px rgba(235,87,87,0)}100%{box-shadow:0 0 0 0 rgba(235,87,87,0)}}.chat-scroll::-webkit-scrollbar{width:6px}.chat-scroll::-webkit-scrollbar-thumb{background-color:#e0e0e0;border-radius:3px}.dark .chat-scroll::-webkit-scrollbar-thumb{background-color:#3f3f3f}textarea{transition:height .1s}@keyframes slideIn{from{transform:translateX(-50%) translateY(-20px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}@keyframes fadeOut{from{opacity:1}to{opacity:0}}.toast-enter{animation:slideIn .3s ease-out forwards}.toast-exit{animation:fadeOut .3s ease-in forwards}</style></head><body class="bg-notion-bg dark:bg-notion-darkBg text-notion-text dark:text-notion-darkText font-sans h-[100dvh] flex flex-col overflow-hidden transition-colors duration-200"><div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-3 pointer-events-none w-full max-w-sm px-4"></div><div id="customConfirmModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-[2px] hidden opacity-0 transition-opacity duration-200"><div class="bg-white dark:bg-[#252525] w-full max-w-sm rounded-lg shadow-notion-modal border border-notion-border dark:border-notion-darkBorder p-0 transform scale-95 transition-transform duration-200" id="confirmModalContent"><div class="p-4 border-b border-notion-border dark:border-notion-darkBorder"><h3 id="confirmTitle" class="font-semibold text-sm">Confirmation</h3></div><div class="p-4"><p id="confirmText" class="text-sm text-gray-600 dark:text-gray-400">Are you sure?</p></div><div class="p-3 flex justify-end gap-2 bg-notion-sidebar dark:bg-notion-darkSidebar rounded-b-lg"><button onclick="closeConfirmModal(!1);
" class="px-3 py-1.5 text-xs font-medium border border-notion-border dark:border-notion-darkBorder rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-300">Cancel</button> <button id="confirmBtnAction" class="px-3 py-1.5 text-xs font-medium bg-red-500 hover:bg-red-600 text-white rounded transition-colors shadow-sm">Confirm</button></div></div></div><header class="bg-white dark:bg-[#191919] border-b border-notion-border dark:border-notion-darkBorder z-30 shrink-0 sticky top-0"><div class="flex items-center justify-between p-3 max-w-3xl mx-auto w-full"><div class="flex items-center gap-2"><a href="/" class="w-8 h-8 flex items-center justify-center rounded hover:bg-notion-hover dark:hover:bg-notion-darkHover transition-colors text-gray-500"><i class="fas fa-chevron-left text-xs"></i></a><div class="flex items-center gap-2"><span class="font-semibold text-sm tracking-tight">Room</span></div></div><div class="flex items-center gap-1"><button onclick="handleRefresh();
" class="w-8 h-8 flex items-center justify-center rounded hover:bg-notion-hover dark:hover:bg-notion-darkHover text-gray-500 transition-colors" title="Reload Page"><i class="fas fa-rotate-right text-xs"></i></button> <button onclick="handleApiKeySettings();
" class="w-8 h-8 flex items-center justify-center rounded hover:bg-notion-hover dark:hover:bg-notion-darkHover text-gray-500 transition-colors" title="Settings"><i class="fas fa-cog text-xs"></i></button> <button onclick="handleClear();
" class="w-8 h-8 flex items-center justify-center rounded hover:bg-notion-hover dark:hover:bg-notion-darkHover text-gray-500 transition-colors" title="Clear Page"><i class="far fa-trash-alt text-xs"></i></button> <button id="themeToggle" class="w-8 h-8 flex items-center justify-center rounded hover:bg-notion-hover dark:hover:bg-notion-darkHover text-gray-500 transition-colors"><i class="fas fa-moon text-xs dark:hidden"></i> <i class="fas fa-sun text-xs hidden dark:block"></i></button><div class="w-px h-4 bg-gray-200 dark:bg-gray-700 mx-1"></div><img id="headerAvatar" src="" class="w-6 h-6 rounded border border-gray-200 dark:border-gray-600 hidden object-cover"> <button id="logoutBtn" onclick="handleLogout();
" class="hidden w-8 h-8 flex items-center justify-center rounded hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-500 transition-colors" title="Logout"><i class="fas fa-sign-out-alt text-xs"></i></button></div></div><div id="settingsBar" class="grid grid-cols-2 gap-px bg-notion-border dark:bg-notion-darkBorder border-b border-notion-border dark:border-notion-darkBorder hidden max-w-3xl mx-auto"><div class="p-2 bg-notion-sidebar dark:bg-[#202020] flex items-center justify-center gap-2"><label class="text-[10px] font-medium text-gray-500 tracking-widest">Your language</label> <select id="myLang" class="bg-transparent text-xs font-semibold outline-none cursor-pointer hover:underline text-notion-text dark:text-notion-darkText"><option value="id-ID" class="dark:bg-[#191919]">Indonesian</option><option value="en-US" class="dark:bg-[#191919]">English</option><option value="ja-JP" class="dark:bg-[#191919]">Japanese</option><option value="ko-KR" class="dark:bg-[#191919]">Korean</option><option value="zh-CN" class="dark:bg-[#191919]">Mandarin</option></select></div><div class="p-2 bg-notion-sidebar dark:bg-[#202020] flex items-center justify-center gap-2"><label class="text-[10px] font-medium text-gray-500 uppercase tracking-widest">Your friends</label> <select id="targetLang" class="bg-transparent text-xs font-semibold outline-none cursor-pointer hover:underline text-notion-text dark:text-notion-darkText"><option value="ja" selected="selected" class="dark:bg-[#191919]">Japanese</option><option value="en" class="dark:bg-[#191919]">English</option><option value="id" class="dark:bg-[#191919]">Indonesian</option><option value="ko" class="dark:bg-[#191919]">Korean</option><option value="zh" class="dark:bg-[#191919]">Mandarin</option></select></div></div></header><main class="flex-1 relative flex flex-col w-full max-w-3xl mx-auto bg-white dark:bg-[#191919] overflow-hidden h-full transition-colors duration-200"><section id="loginSection" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-white dark:bg-[#191919] p-6 text-center"><div class="mb-6"><span class="text-6xl">ðŸ‘‹</span></div><h2 class="text-2xl font-bold mb-2 tracking-tight text-notion-text dark:text-notion-darkText">Welcome to realtime chat!</h2><p class="text-gray-500 dark:text-gray-400 mb-3 text-sm max-w-xs mx-auto font-serif italic">"Connect, speak, and understand seamlessly."</p><p class="text-gray-500 dark:text-gray-400 mb-8 text-sm max-w-xs mx-auto font-serif italic">Let's sign here</p><button id="googleLoginBtn" class="bg-white dark:bg-[#252525] border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 px-5 py-2.5 rounded hover:bg-gray-50 dark:hover:bg-[#2F2F2F] shadow-sm flex items-center gap-3 text-sm font-medium transition-all w-full max-w-xs justify-center"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-4 h-4 grayscale opacity-80"> <span>Continue with Google</span></button></section><section id="dashboardSection" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-white dark:bg-[#191919] p-6 hidden"><div class="w-full max-w-sm bg-white dark:bg-[#191919] rounded-lg border border-notion-border dark:border-notion-darkBorder p-0 shadow-sm"><div class="p-5 border-b border-notion-border dark:border-notion-darkBorder"><h3 id="dashName" class="font-bold text-lg text-notion-text dark:text-notion-darkText mb-1">Welcome back</h3><p class="text-xs text-gray-500">Scan QR to join room or copy link.</p></div><div class="p-6 flex items-center justify-center min-h-[220px] bg-notion-sidebar dark:bg-[#202020] relative"><div id="qrLoader" class="text-gray-400 absolute"><i class="fas fa-circle-notch fa-spin text-xl"></i></div><img id="qrImage" src="" class="w-48 h-48 object-contain hidden mix-blend-multiply dark:mix-blend-normal z-10 opacity-90"></div><div class="p-4 space-y-2"><button onclick="copyRoomLink();
" class="w-full py-2 rounded bg-black dark:bg-white text-white dark:text-black text-xs font-semibold hover:opacity-80 transition-opacity flex items-center justify-center gap-2"><i class="fas fa-link"></i> Copy Link</button> <button onclick="enterRoomSelf();
" class="w-full py-2 rounded bg-transparent border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-xs font-semibold hover:bg-gray-50 dark:hover:bg-[#2F2F2F] transition-all">Enter Room</button></div></div></section><section id="chatSection" class="flex-1 flex flex-col relative hidden h-full"><div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-6 chat-scroll pb-24 bg-white dark:bg-[#191919]"><div id="emptyState" class="text-center mt-20 opacity-50"><div class="w-12 h-12 bg-notion-sidebar dark:bg-[#252525] rounded-full flex items-center justify-center mx-auto mb-3"><i class="fas fa-quote-left text-gray-400 text-lg"></i></div><p class="text-sm font-medium text-gray-600 dark:text-gray-400">Start the conversation</p><p class="text-xs text-gray-400 mt-1">Press microphone or type to translate</p></div><div id="typingIndicator" class="hidden flex gap-2 mb-4 items-center animate-fade-in pl-2"><div class="text-[10px] text-gray-400 italic mr-2">Typing</div><div class="flex gap-1"><div class="w-1 h-1 bg-gray-400 rounded-full animate-bounce"></div><div class="w-1 h-1 bg-gray-400 rounded-full animate-bounce [animation-delay:0.1s]"></div><div class="w-1 h-1 bg-gray-400 rounded-full animate-bounce [animation-delay:0.2s]"></div></div></div></div><div id="loadingOverlay" class="absolute bottom-24 left-1/2 -translate-x-1/2 hidden z-40 transition-all pointer-events-none"><div class="bg-black/80 dark:bg-white/90 backdrop-blur text-white dark:text-black px-3 py-1.5 rounded shadow-sm text-xs font-medium flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> <span>Translating...</span></div></div><div class="bg-white dark:bg-[#191919] border-t border-notion-border dark:border-notion-darkBorder p-4 z-30 shrink-0 flex items-end gap-3 transition-colors duration-200"><div class="flex-1 bg-notion-sidebar dark:bg-[#252525] rounded flex items-center px-3 py-2 border border-transparent focus-within:border-gray-300 dark:focus-within:border-gray-600 transition-all"><textarea id="chatInput" rows="1" class="bg-transparent w-full outline-none text-sm text-gray-800 dark:text-gray-200 resize-none max-h-32 py-1 custom-scroll leading-relaxed placeholder-gray-400" placeholder="Type something..."></textarea></div><button id="sendBtn" class="w-10 h-10 rounded bg-black dark:bg-white text-white dark:text-black shadow-sm flex items-center justify-center active:scale-95 transition-all shrink-0 hidden hover:opacity-80"><i class="fas fa-arrow-up text-sm"></i></button> <button id="recordBtn" class="w-10 h-10 rounded border border-gray-200 dark:border-gray-600 bg-white dark:bg-[#252525] text-gray-600 dark:text-gray-300 shadow-sm flex items-center justify-center active:scale-95 transition-all shrink-0 hover:bg-gray-50 dark:hover:bg-[#2F2F2F]"><i class="fas fa-microphone text-sm"></i></button></div></section></main><div id="guideModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-[2px] hidden transition-opacity duration-300"><div class="bg-white dark:bg-[#191919] w-11/12 max-w-lg rounded-lg shadow-notion-modal flex flex-col max-h-[85vh] transform transition-all scale-100 border border-notion-border dark:border-notion-darkBorder"><div class="p-5 border-b border-notion-border dark:border-notion-darkBorder flex justify-between items-center bg-notion-sidebar dark:bg-[#202020] rounded-t-lg"><h3 class="font-bold text-sm text-gray-800 dark:text-white flex items-center gap-2">ðŸ“– How to use</h3><button onclick="closeGuide();
" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"><i class="fas fa-times text-sm"></i></button></div><div class="p-6 overflow-y-auto space-y-6 text-sm text-gray-600 dark:text-gray-300 custom-scrollbar font-serif"><div class="bg-gray-50 dark:bg-[#252525] p-3 rounded border border-gray-100 dark:border-gray-700 italic"><p>"Realtime translation for seamless communication."</p></div><ul class="space-y-4 list-disc pl-4 text-xs md:text-sm"><li><strong>Connect:</strong> Share QR Code/Link with a friend.</li><li><strong>Speak/Type:</strong> Input your message in your language.</li><li><strong>Translate:</strong> System automatically translates to target language.</li><li class="animate-pulse text-green-500"><strong>Insert Your Apikey: </strong>Now you can insert yout private Apikey</li></ul><div class="p-3 bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/20 rounded flex gap-3"><span class="text-lg">ðŸ’¡</span><p class="text-xs text-gray-600 dark:text-gray-400 pt-1">Ensure stable internet connection for best performance.</p></div></div><div class="p-4 border-t border-notion-border dark:border-notion-darkBorder bg-white dark:bg-[#191919] rounded-b-lg"><button onclick="closeGuide();
" class="w-full bg-black dark:bg-white text-white dark:text-black font-medium py-2 px-4 rounded shadow-sm text-sm hover:opacity-80 transition-opacity">Get Started</button></div></div></div><div id="apiKeyModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-[2px] hidden transition-all duration-300 opacity-0"><div class="bg-white dark:bg-[#191919] w-11/12 max-w-md rounded-lg shadow-notion-modal transform transition-all scale-95 border border-notion-border dark:border-notion-darkBorder overflow-hidden" onclick="event.stopPropagation();
"><div class="p-4 border-b border-notion-border dark:border-notion-darkBorder bg-notion-sidebar dark:bg-[#202020] flex justify-between items-center"><h3 class="font-bold text-sm text-gray-800 dark:text-white flex items-center gap-2">ðŸ”‘ Gemini API Configuration</h3><button onclick="closeApiKeyModal();
" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"><i class="fas fa-times text-sm"></i></button></div><div class="p-6 space-y-4"><div><label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Your API Key</label> <input type="text" id="inputGeminiKey" placeholder="Paste your key here..." class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-[#252525] text-gray-800 dark:text-gray-100 focus:outline-none focus:border-black dark:focus:border-white transition-all text-xs font-mono"><p class="text-[10px] text-gray-400 mt-2">Stored locally. Leave empty to use shared quota.</p><a href="https://aistudio.google.com/app/apikey" target="_blank" class="inline-block mt-2 text-[10px] font-semibold text-gray-500 hover:text-black dark:hover:text-white underline decoration-dotted">Get API Key &nearr;</a></div></div><div class="p-4 border-t border-notion-border dark:border-notion-darkBorder bg-gray-50 dark:bg-[#202020] flex items-center justify-between gap-3"><button onclick="deleteUserApiKey();
" class="px-3 py-1.5 rounded text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 text-xs font-medium transition-colors">Reset</button><div class="flex gap-2"><button onclick="closeApiKeyModal();
" class="px-3 py-1.5 rounded text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#2F2F2F] text-xs font-medium transition-colors">Cancel</button> <button onclick="saveUserApiKey();
" class="px-3 py-1.5 rounded bg-black dark:bg-white text-white dark:text-black text-xs font-bold shadow-sm hover:opacity-80 transition-opacity">Save</button></div></div></div></div><script>function showToast(e,o,s="info"){const a=document.getElementById("toast-container"),t=document.createElement("div");t.className="pointer-events-auto bg-white dark:bg-[#252525] border border-l-4 shadow-notion rounded p-3 flex gap-3 items-start transform transition-all duration-300 toast-enter",s==="success"?t.classList.add("border-gray-200","border-l-green-500","dark:border-gray-700"):s==="error"?t.classList.add("border-gray-200","border-l-red-500","dark:border-gray-700"):t.classList.add("border-gray-200","border-l-blue-500","dark:border-gray-700");let d='<i class="fas fa-info-circle text-blue-500"></i>';s==="success"&&(d='<i class="fas fa-check-circle text-green-500"></i>'),s==="error"&&(d='<i class="fas fa-exclamation-circle text-red-500"></i>'),t.innerHTML=`
              <div class="mt-0.5">${d}</div>
              <div class="flex-1">
                  <h4 class="text-xs font-bold text-gray-800 dark:text-gray-100">${e}</h4>
                  ${o?`<p class="text-[10px] text-gray-500 dark:text-gray-400 mt-0.5 leading-tight">${o}</p>`:""}
              </div>
          `,a.appendChild(t),setTimeout(()=>{t.classList.remove("toast-enter"),t.classList.add("toast-exit"),setTimeout(()=>t.remove(),300)},3e3)}let confirmCallback=null;const confirmModal=document.getElementById("customConfirmModal"),confirmContent=document.getElementById("confirmModalContent");function openConfirmModal(e,o,s="red",a){document.getElementById("confirmTitle").textContent=e,document.getElementById("confirmText").textContent=o;const t=document.getElementById("confirmBtnAction");t.className=`px-3 py-1.5 text-xs font-medium rounded transition-colors shadow-sm text-white ${s==="red"?"bg-red-500 hover:bg-red-600":"bg-black hover:bg-gray-800 dark:bg-white dark:text-black"}`,confirmCallback=a,confirmModal.classList.remove("hidden"),setTimeout(()=>{confirmModal.classList.remove("opacity-0"),confirmContent.classList.remove("scale-95"),confirmContent.classList.add("scale-100")},10)}function closeConfirmModal(e){e&&confirmCallback&&confirmCallback(),confirmContent.classList.remove("scale-100"),confirmContent.classList.add("scale-95"),confirmModal.classList.add("opacity-0"),setTimeout(()=>{confirmModal.classList.add("hidden"),confirmCallback=null},200)}document.getElementById("confirmBtnAction").onclick=()=>closeConfirmModal(!0);function showGuideModal(){const e=document.getElementById("guideModal");e&&(e.classList.remove("hidden"),setTimeout(()=>{e.firstElementChild.classList.remove("scale-95","opacity-0"),e.classList.remove("opacity-0")},10))}function closeGuide(){const e=document.getElementById("guideModal");e&&(e.classList.add("opacity-0"),setTimeout(()=>{e.classList.add("hidden")},300),localStorage.setItem("realtime_guide_seen","true"))}document.addEventListener("DOMContentLoaded",()=>{localStorage.getItem("realtime_guide_seen")!=="true"&&showGuideModal()});</script><script type="module">var y=(t,s,a)=>new Promise((i,n)=>{var o=g=>{try{h(a.next(g))}catch(b){n(b)}},r=g=>{try{h(a.throw(g))}catch(b){n(b)}},h=g=>g.done?i(g.value):Promise.resolve(g.value).then(o,r);h((a=a.apply(t,s)).next())});import{initializeApp as K}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getAuth as A,signInWithPopup as H,signOut as q,GoogleAuthProvider as D,onAuthStateChanged as U}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getDatabase as j,ref as u,push as O,onChildAdded as N,onChildRemoved as P,remove as x,serverTimestamp as F,set as G,onValue as J,onDisconnect as z}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";const v=document.documentElement,Y=document.getElementById("themeToggle");function Q(){localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?v.classList.add("dark"):v.classList.remove("dark")}Y.addEventListener("click",()=>{v.classList.toggle("dark"),localStorage.theme=v.classList.contains("dark")?"dark":"light"}),Q();const V={apiKey:"AIzaSyBrTCPosHt9RIOpAMfxgOqCuDqJEd746lc",authDomain:"projects-language.firebaseapp.com",databaseURL:"https://projects-language-default-rtdb.firebaseio.com",projectId:"projects-language",storageBucket:"projects-language.firebasestorage.app",messagingSenderId:"764367056230",appId:"1:764367056230:web:84817b2427c435a63c2ca7",measurementId:"G-938GHYDMCL"},$=K(V),I=A($),p=j($),W=new D;let l=null,d=null,c=null,f=!1,L=!1,M=null,B=null,S=null,E=null;const e={loginSection:document.getElementById("loginSection"),dashboardSection:document.getElementById("dashboardSection"),chatSection:document.getElementById("chatSection"),settingsBar:document.getElementById("settingsBar"),loginBtn:document.getElementById("googleLoginBtn"),logoutBtn:document.getElementById("logoutBtn"),headerAvatar:document.getElementById("headerAvatar"),dashName:document.getElementById("dashName"),qrLoader:document.getElementById("qrLoader"),qrImage:document.getElementById("qrImage"),messages:document.getElementById("messagesContainer"),emptyState:document.getElementById("emptyState"),recordBtn:document.getElementById("recordBtn"),sendBtn:document.getElementById("sendBtn"),chatInput:document.getElementById("chatInput"),loadingOverlay:document.getElementById("loadingOverlay"),myLang:document.getElementById("myLang"),targetLang:document.getElementById("targetLang")},m=document.getElementById("apiKeyModal"),k=document.getElementById("inputGeminiKey");window.handleApiKeySettings=()=>{const t=localStorage.getItem("geminiUserKey")||"";k.value=t,m.classList.remove("hidden"),setTimeout(()=>{m.classList.remove("opacity-0"),m.firstElementChild.classList.remove("scale-95"),m.firstElementChild.classList.add("scale-100")},10)},window.closeApiKeyModal=()=>{m.classList.add("opacity-0"),m.firstElementChild.classList.remove("scale-100"),m.firstElementChild.classList.add("scale-95"),setTimeout(()=>{m.classList.add("hidden")},300)},window.saveUserApiKey=()=>{const t=k.value.trim();if(t.length>0&&t.length<10){showToast("Invalid Key","Key too short!","error");return}t?(localStorage.setItem("geminiUserKey",t),showToast("Saved","API Key stored locally.","success")):(localStorage.removeItem("geminiUserKey"),showToast("Default Mode","Using server quota.","info")),closeApiKeyModal()},window.deleteUserApiKey=()=>{localStorage.removeItem("geminiUserKey"),k.value="",showToast("Reset","Key removed.","info")},m.addEventListener("click",t=>{t.target===m&&closeApiKeyModal()}),U(I,t=>{if(l=t,t){e.loginSection.classList.add("hidden"),e.headerAvatar.src=t.photoURL,e.headerAvatar.classList.remove("hidden"),e.logoutBtn.classList.remove("hidden");const a=new URLSearchParams(window.location.search).get("room");a?T(a):X()}else e.loginSection.classList.remove("hidden"),e.dashboardSection.classList.add("hidden"),e.chatSection.classList.add("hidden"),e.settingsBar.classList.add("hidden"),e.headerAvatar.classList.add("hidden"),e.logoutBtn.classList.add("hidden"),e.messages.innerHTML=""}),e.loginBtn.onclick=()=>H(I,W).catch(t=>showToast("Login Failed",t.message,"error")),window.handleLogout=()=>{openConfirmModal("Log out?","You will be signed out from this session.","red",()=>{q(I).then(()=>{window.location.href="/"})})},window.handleRefresh=()=>{if(!d)return;e.messages.innerHTML="",e.messages.appendChild(e.emptyState),e.emptyState.style.display="block",T(d);const t=document.querySelector('button[onclick="handleRefresh()"] i');t&&(t.classList.add("fa-spin"),setTimeout(()=>t.classList.remove("fa-spin"),1e3))},window.handleClear=()=>{d&&openConfirmModal("Delete History?","All messages in this room will be permanently deleted.","red",()=>y(null,null,function*(){try{yield x(u(p,`rooms/${d}/messages`)),e.messages.innerHTML="",e.messages.appendChild(e.emptyState),e.emptyState.style.display="block",showToast("Success","Chat history deleted.","success")}catch(t){showToast("Error",t.message,"error")}}))};function X(){return y(this,null,function*(){e.dashboardSection.classList.remove("hidden"),e.chatSection.classList.add("hidden"),e.dashName.textContent=`Hi, ${l.displayName.split(" ")[0]}`,d||(d="RM-"+Math.random().toString(36).substr(2,6).toUpperCase());const t=`${window.location.origin}/realtime-translation?room=${d}`;try{const a=yield(yield fetch("/api/generate-qr",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})})).json();a.qrImage&&(e.qrImage.src=a.qrImage,e.qrImage.classList.remove("hidden"),e.qrLoader.classList.add("hidden"))}catch(s){console.error("QR Error",s)}})}window.copyRoomLink=()=>{const t=`${window.location.origin}/realtime-translation?room=${d}`;navigator.clipboard.writeText(t),showToast("Copied!","Room link copied to clipboard","success")},window.enterRoomSelf=()=>{const t=`${window.location.pathname}?room=${d}`;window.history.pushState({path:t},"",t),T(d)};function T(t){d=t,e.dashboardSection.classList.add("hidden"),e.chatSection.classList.remove("hidden"),e.settingsBar.classList.remove("hidden"),e.settingsBar.classList.add("grid"),e.chatInput.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),w())}),S&&S(),E&&E(),B&&B();let s=document.getElementById("typingIndicator");s?s.remove():(s=document.createElement("div"),s.id="typingIndicator",s.className="hidden flex gap-2 mb-4 items-center animate-fade-in pl-2",s.innerHTML=`
              <div class="text-[10px] text-gray-400 italic mr-2">Typing</div>
              <div class="flex gap-1">
                <div class="w-1 h-1 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-1 h-1 bg-gray-400 rounded-full animate-bounce [animation-delay:0.1s]"></div>
                <div class="w-1 h-1 bg-gray-400 rounded-full animate-bounce [animation-delay:0.2s]"></div>
              </div>
          `),e.messages.innerHTML="",e.messages.appendChild(e.emptyState),e.messages.appendChild(s);const a=u(p,`rooms/${t}/messages`);S=N(a,n=>{const o=n.val();o&&(e.emptyState.style.display="none",te(o,n.key),e.messages.appendChild(s),e.messages.scrollTop=e.messages.scrollHeight)}),E=P(a,n=>{const o=document.getElementById(`msg-${n.key}`);o&&(o.remove(),e.messages.children.length<=2&&(e.emptyState.style.display="block"))});const i=e.chatInput.oninput;e.chatInput.addEventListener("input",()=>{if(!d||!l)return;e.chatInput.style.height="auto",e.chatInput.style.height=e.chatInput.scrollHeight+"px",e.chatInput.value.trim().length>0?(e.sendBtn.classList.remove("hidden"),e.recordBtn.classList.add("hidden")):(e.sendBtn.classList.add("hidden"),e.recordBtn.classList.remove("hidden"));const n=u(p,`rooms/${d}/typing/${l.uid}`);G(n,!0),z(n).remove(),clearTimeout(M),M=setTimeout(()=>{x(n)},2e3)}),Z(t),_(),e.sendBtn.onclick=w}function Z(t){const s=document.getElementById("typingIndicator");if(!s)return;const a=u(p,`rooms/${t}/typing`);B=J(a,i=>{const n=i.val();let o=!1;n&&Object.keys(n).forEach(r=>{r!==l.uid&&(o=!0)}),o?(s.classList.remove("hidden"),e.messages.scrollTop=e.messages.scrollHeight):s.classList.add("hidden")})}function ie(){const t=e.chatInput,s=e.sendBtn,a=e.recordBtn;t.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px",this.value.trim().length>0?(s.classList.remove("hidden"),a.classList.add("hidden")):(s.classList.add("hidden"),a.classList.remove("hidden"))}),t.addEventListener("keydown",i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),w())}),s.addEventListener("click",w)}function w(){const t=e.chatInput.value.trim();t&&(L||(e.chatInput.value="",e.chatInput.style.height="auto",e.sendBtn.classList.add("hidden"),e.recordBtn.classList.remove("hidden"),R(t)))}function _(){const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t)return;c=new t,c.continuous=!1,c.interimResults=!1,c.onstart=()=>{f=!0,C(!0)},c.onend=()=>{f=!1,C(!1)},c.onerror=n=>{f=!1,C(!1)},c.onresult=n=>{const o=n.results[0][0].transcript;o&&o.trim().length>0&&R(o)};const s=e.recordBtn,a=n=>{if(n.preventDefault(),!(f||L)){c.lang=e.myLang.value;try{c.start()}catch(o){}}},i=n=>{n.preventDefault(),f&&c.stop()};s.addEventListener("mousedown",a),s.addEventListener("mouseup",i),s.addEventListener("touchstart",a),s.addEventListener("touchend",i)}function C(t){const s=e.recordBtn;t?(s.classList.add("bg-red-500","text-white","recording-pulse","border-red-500"),s.classList.remove("bg-white","dark:bg-[#252525]","text-gray-600","dark:text-gray-300")):(s.classList.remove("bg-red-500","text-white","recording-pulse","border-red-500"),s.classList.add("bg-white","dark:bg-[#252525]","text-gray-600","dark:text-gray-300"))}function ee(t=5){const s=document.querySelectorAll('#messagesContainer > div[id^="msg-"]');let a=[];const i=Math.max(0,s.length-t);for(let n=i;n<s.length;n++){const r=s[n].querySelector(".text-\\[15px\\]");r&&a.push(r.innerText.trim())}return a.join(`
`)}function R(t){return y(this,null,function*(){if(!l)return;L=!0,e.loadingOverlay.classList.remove("hidden");const s=e.myLang.value.split("-")[0],a=e.targetLang.value,i=localStorage.getItem("geminiUserKey"),n=ee(5);try{const r=yield(yield fetch("/api/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t,fromLang:s,toLang:a,userApiKey:i,context:n})})).json();if(r.error){showToast("Translation Error",r.message||"Failed to translate.","error");return}const h={uid:l.uid,name:l.displayName||"User",photo:l.photoURL,original:t||"",translated:r.translatedText||t,pronunciation:r.transliteration||"",fromLang:s,toLang:a,timestamp:F()};yield O(u(p,`rooms/${d}/messages`),h)}catch(o){console.error(o),showToast("Network Error","Check your connection.","error")}finally{L=!1,e.loadingOverlay.classList.add("hidden")}})}function te(t,s){const a=l&&t.uid===l.uid;let i="",n="";const o=t.pronunciation?`<div class="text-[10px] opacity-60 font-mono mt-1 pt-1 border-t border-gray-400/20 inline-block tracking-tight">${t.pronunciation}</div>`:"";a?(i=`<div class="text-[15px] leading-relaxed text-white">${t.original}</div>`,n=`
                    <div class="mt-1.5 pt-1 border-t border-white/20 text-xs text-gray-200 flex flex-col gap-0.5">
                        <div class="font-serif italic opacity-90">${t.translated}</div>
                        ${o}
                    </div>`):(i=`<div class="text-[15px] leading-relaxed text-notion-text dark:text-notion-darkText font-medium">${t.translated}</div>`,n=`
                    <div class="mt-1.5 pt-1 border-t border-gray-200 dark:border-gray-600 text-xs text-gray-500 dark:text-gray-400 flex flex-col gap-0.5">
                        <div class="font-serif italic">"${t.original}"</div>
                        ${o}
                    </div>`);const r=document.createElement("div");r.id=`msg-${s}`,r.className=`flex gap-2 animate-fade-in mb-4 group ${a?"flex-row-reverse":"flex-row"}`;const h=a?`
                <button onclick="deleteMessage('${s}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-gray-300 hover:text-red-500 self-center px-2">
                    <i class="fas fa-trash-alt text-xs"></i>
                </button>`:"",g=a?"bg-[#2F2F2F] dark:bg-gray-600 text-white dark:text-black rounded-lg rounded-br-none shadow-sm":"bg-white dark:bg-[#252525] border border-gray-200 dark:border-gray-700 text-notion-text dark:text-notion-darkText rounded-lg rounded-bl-none shadow-sm";r.innerHTML=`
                <img src="${t.photo}" class="w-8 h-8 rounded border border-gray-200 dark:border-gray-600 mt-auto object-cover bg-gray-100">
                <div class="flex flex-col max-w-[85%] ${a?"items-end":"items-start"}">
                    <span class="text-[10px] text-gray-400 px-1 mb-0.5">${t.name}</span>
                    <div class="px-3 py-2 ${g}">
                        ${i}
                        ${n}
                    </div>
                </div>
                ${h}
            `,e.messages.appendChild(r),e.messages.scrollTop=e.messages.scrollHeight}window.deleteMessage=t=>y(null,null,function*(){if(!(!l||!d))try{yield x(u(p,`rooms/${d}/messages/${t}`))}catch(s){console.error(s)}});</script></body></html>