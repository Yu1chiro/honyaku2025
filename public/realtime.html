<!DOCTYPE html>
<html lang="id" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Realtime Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        brand: { blue: '#3b82f6', purple: '#8b5cf6', dark: '#1e293b' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        .recording-pulse { animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .dark .chat-scroll::-webkit-scrollbar-thumb { background-color: #4b5563; }
        
        textarea { transition: height 0.1s; }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans h-[100dvh] flex flex-col overflow-hidden transition-colors duration-200">

    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm z-30 shrink-0 transition-colors duration-200">
        <div class="flex items-center justify-between p-3">
            <div class="flex items-center gap-3">
                <a href="/" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <i class="fas fa-arrow-left text-gray-600 dark:text-gray-300"></i>
                </a>
                <span class="font-bold text-gray-700 dark:text-gray-200 text-sm md:text-base">Lobby</span>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="handleRefresh()" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors" title="Refresh Connection">
                    <i class="fas fa-sync-alt"></i>
                </button>

                <button onclick="handleClear()" class="w-8 h-8 flex items-center justify-center rounded-full bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors" title="Bersihkan Layar">
                    <i class="fas fa-trash"></i>
                </button>

                <button id="themeToggle" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>

                <img id="headerAvatar" src="" class="w-8 h-8 rounded-full border border-gray-200 dark:border-gray-600 hidden object-cover">
                
                <button id="logoutBtn" onclick="handleLogout()" class="hidden w-8 h-8 flex items-center justify-center rounded-full bg-red-50 dark:bg-red-900/20 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div id="settingsBar" class="grid grid-cols-2 gap-0 border-t border-gray-100 dark:border-gray-700 divide-x divide-gray-100 dark:divide-gray-700 hidden transition-all">
            <div class="p-2 bg-blue-50/50 dark:bg-blue-900/20">
                <label class="block text-[10px] uppercase font-bold text-blue-600 dark:text-blue-400 mb-1 tracking-wider">
                    <i class="fas fa-microphone mr-1"></i> Your Language
                </label>
                <select id="myLang" class="w-full bg-transparent font-semibold text-sm outline-none text-gray-800 dark:text-gray-200">
                    <option value="id-ID" class="dark:bg-gray-800">ğŸ‡®ğŸ‡© Indonesia</option>
                    <option value="en-US" class="dark:bg-gray-800">ğŸ‡ºğŸ‡¸ English</option>
                    <option value="ja-JP" class="dark:bg-gray-800">ğŸ‡¯ğŸ‡µ Japanese</option>
                    <option value="ko-KR" class="dark:bg-gray-800">ğŸ‡°ğŸ‡· Korean</option>
                    <option value="zh-CN" class="dark:bg-gray-800">ğŸ‡¨ğŸ‡³ Mandarin</option>
                    <option value="my-MM" class="dark:bg-gray-800">ğŸ‡²ğŸ‡² Myanmar</option>
                    <option value="th-TH" class="dark:bg-gray-800">ğŸ‡¹ğŸ‡­ Thai</option>
                </select>
            </div>

            <div class="p-2 bg-purple-50/50 dark:bg-purple-900/20">
                <label class="block text-[10px] uppercase font-bold text-purple-600 dark:text-purple-400 mb-1 tracking-wider">
                    <i class="fas fa-language mr-1"></i> Your Friends
                </label>
                <select id="targetLang" class="w-full bg-transparent font-semibold text-sm outline-none text-gray-800 dark:text-gray-200">
                    <option value="ja" selected class="dark:bg-gray-800">ğŸ‡¯ğŸ‡µ Japanese</option>
                    <option value="en" class="dark:bg-gray-800">ğŸ‡ºğŸ‡¸ English</option>
                    <option value="id" class="dark:bg-gray-800">ğŸ‡®ğŸ‡© Indonesia</option>
                    <option value="ko" class="dark:bg-gray-800">ğŸ‡°ğŸ‡· Korean</option>
                    <option value="zh" class="dark:bg-gray-800">ğŸ‡¨ğŸ‡³ Mandarin</option>
                    <option value="my" class="dark:bg-gray-800">ğŸ‡²ğŸ‡² Myanmar</option>
                    <option value="th" class="dark:bg-gray-800">ğŸ‡¹ğŸ‡­ Thai</option>
                    <option value="fr" class="dark:bg-gray-800">ğŸ‡«ğŸ‡· French</option>
                </select>
            </div>
        </div>
    </header>

    <main class="flex-1 relative flex flex-col w-full max-w-lg mx-auto bg-white dark:bg-gray-800 shadow-lg overflow-hidden h-full transition-colors duration-200">
        
        <section id="loginSection" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-white dark:bg-gray-900 p-6 text-center transition-colors duration-200">
            <h2 class="text-2xl font-bold mb-2 text-gray-800 dark:text-white">Welcome!</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-8 text-sm max-w-xs mx-auto">Please login first!</p>
            <button id="googleLoginBtn" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 px-6 py-3 rounded-xl shadow-md flex items-center gap-3 font-medium active:scale-95 transition-transform hover:bg-gray-50 dark:hover:bg-gray-700 w-full max-w-xs justify-center">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
                <span>Signin with google</span>
            </button>
        </section>

        <section id="dashboardSection" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-white dark:bg-gray-900 p-6 hidden transition-colors duration-200">
            <div class="w-full max-w-sm bg-white dark:bg-gray-800 rounded-3xl border border-gray-200 dark:border-gray-700 shadow-xl p-6 text-center">
                <div class="mb-4">
                    <h3 id="dashName" class="font-bold text-lg text-gray-800 dark:text-white">Hi, User</h3>
                    <p class="text-xs text-gray-400">Scan QR Code for join this room!</p>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl mb-4 flex items-center justify-center min-h-[220px] border border-gray-100 dark:border-gray-600 relative">
                    <div id="qrLoader" class="text-blue-500 absolute"><i class="fas fa-circle-notch fa-spin text-3xl"></i></div>
                    <img id="qrImage" src="" class="w-48 h-48 object-contain hidden mix-blend-multiply dark:mix-blend-normal z-10">
                </div>

                <div class="space-y-3">
                    <button onclick="copyRoomLink()" class="w-full py-3 rounded-xl bg-blue-600 text-white text-sm font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-link"></i> Salin Link
                    </button>
                    <button onclick="enterRoomSelf()" class="w-full py-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 active:scale-95 transition-all">
                        Masuk ke Room
                    </button>
                </div>
            </div>
        </section>

        <section id="chatSection" class="flex-1 flex flex-col relative hidden h-full">
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 chat-scroll pb-20 bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
                <div id="emptyState" class="text-center mt-20 opacity-40">
                    <i class="fas fa-microphone-lines text-gray-400 dark:text-gray-600 text-4xl mb-3"></i>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Mulai bicara atau ketik untuk menerjemahkan</p>
                </div>
            </div>

            <div id="loadingOverlay" class="absolute bottom-24 left-1/2 -translate-x-1/2 hidden z-40 transition-all">
                <div class="bg-gray-800/90 dark:bg-white/90 backdrop-blur-sm text-white dark:text-gray-800 px-4 py-2 rounded-full text-xs font-medium flex items-center gap-2 shadow-xl border border-white/10 dark:border-gray-200">
                    <i class="fas fa-spinner fa-spin text-blue-400 dark:text-blue-600"></i>
                    <span>Menerjemahkan...</span>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700 p-3 z-30 shrink-0 shadow-[0_-5px_15px_rgba(0,0,0,0.02)] flex items-end gap-2 transition-colors duration-200">
                
                <div class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-[24px] flex items-center px-4 py-2 border border-transparent focus-within:border-blue-400 focus-within:bg-white dark:focus-within:bg-gray-800 transition-all">
                    <textarea id="chatInput" rows="1" class="bg-transparent w-full outline-none text-sm text-gray-700 dark:text-gray-200 resize-none max-h-24 py-1 custom-scroll leading-relaxed" placeholder="Ketik pesan..."></textarea>
                </div>

                <button id="sendBtn" class="w-12 h-12 rounded-full bg-blue-600 text-white shadow-lg shadow-blue-500/30 flex items-center justify-center active:scale-90 transition-all shrink-0 hidden hover:bg-blue-700">
                    <i class="fas fa-paper-plane text-lg translate-x-[-1px] translate-y-[1px]"></i>
                </button>

                <button id="recordBtn" class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg shadow-blue-500/30 flex items-center justify-center active:scale-90 transition-all shrink-0 select-none touch-manipulation cursor-pointer">
                    <i class="fas fa-microphone text-lg"></i>
                </button>
            </div>
        </section>

    </main>

<div id="guideModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden transition-opacity duration-300">
    <div class="bg-white dark:bg-gray-800 w-11/12 max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[85vh] transform transition-all scale-100 border border-gray-100 dark:border-gray-700">
        
        <div class="p-5 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 rounded-t-2xl">
            <h3 class="font-bold text-lg text-gray-800 dark:text-white flex items-center gap-2">
                <i class="fas fa-book-open text-blue-500"></i>Tutorial
            </h3>
            <button onclick="closeGuide()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6 overflow-y-auto space-y-6 text-sm text-gray-600 dark:text-gray-300 custom-scrollbar">
            
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800/30">
                <h4 class="font-semibold text-blue-700 dark:text-blue-300 mb-2">Welcome to realtime conversation</h4>
                <p class="leading-relaxed">
                    This feature connects two users (e.g., you & a Foreign Friend) via QR Code Scan. The system will automatically translate the two-way conversation.
                </p>
            </div>

            <div>
                <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-3 border-l-4 border-purple-500 pl-3">
                   For example : 
                </h4>
                
                <div class="space-y-4 relative before:absolute before:inset-0 before:ml-5 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-gray-300 before:to-transparent">
                    
                    <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                        <div class="flex items-center justify-center w-10 h-10 rounded-full border border-white bg-red-100 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10">
                            <span class="text-red-600 font-bold">A</span>
                        </div>
                        <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-100 dark:border-gray-600 shadow-sm">
                            <div class="font-bold text-gray-900 dark:text-white mb-1">Japanese friends ğŸ‡¯ğŸ‡µ</div>
                            <div class="text-xs italic mb-1">"ä»Šæ—¥ã¯ä½•ã—ã¦ã‚‹ã®ï¼Ÿ"</div>
                            <div class="text-[10px] text-gray-500 dark:text-gray-400">Voice â†’ Text â†’ Translate</div>
                        </div>
                    </div>

                    <div class="flex justify-center w-full -my-2 relative z-0">
                        <i class="fas fa-arrow-down text-gray-300 text-xs"></i>
                    </div>

                    <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                         <div class="flex items-center justify-center w-10 h-10 rounded-full border border-white bg-green-100 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10">
                            <span class="text-green-600 font-bold">B</span>
                        </div>
                         <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] p-3 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800">
                            <div class="font-bold text-gray-900 dark:text-white mb-1">received by you ğŸ‡®ğŸ‡©</div>
                            <div class="text-xs font-medium text-blue-600 dark:text-blue-300">"Lagi apa hari ini?"</div>
                            <div class="text-[10px] text-gray-500 dark:text-gray-400">The translation result will appear for your Japanese friend.</div>
                        </div>
                    </div>

                     <div class="flex justify-center w-full -my-2 relative z-0">
                        <i class="fas fa-arrow-down text-gray-300 text-xs"></i>
                    </div>

                    <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                        <div class="flex items-center justify-center w-10 h-10 rounded-full border border-white bg-green-100 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10">
                           <span class="text-green-600 font-bold">B</span>
                       </div>
                        <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-100 dark:border-gray-600 shadow-sm">
                           <div class="font-bold text-gray-900 dark:text-white mb-1">Your Message ğŸ‡®ğŸ‡©</div>
                           <div class="text-xs italic mb-1">"Aku sedang belajar."</div>
                           <div class="text-[10px] text-gray-500 dark:text-gray-400">Translate: "ç§ã¯å‹‰å¼·ã—ã¦ã„ã¾ã™"</div>
                       </div>
                   </div>

                </div>
            </div>

            <div class="bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg flex gap-3 items-start border border-orange-100 dark:border-orange-800/30">
                <i class="fas fa-lightbulb text-orange-500 mt-1"></i>
                <div>
                    <span class="font-bold text-orange-700 dark:text-orange-400 text-xs block mb-1">Tips:</span>
                    <p class="text-xs text-gray-600 dark:text-gray-400">Make sure your internet connection is stable and smooth. Happy translation!</p>
                </div>
            </div>
        </div>

        <div class="p-5 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 rounded-b-2xl">
            <button onclick="closeGuide()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-xl shadow-lg shadow-blue-500/30 transition-all active:scale-95">
               Let's started
            </button>
        </div>
    </div>
</div>

<script>
    // --- Logic Modal Panduan ---
    
    // Fungsi untuk menampilkan modal
    function showGuideModal() {
        const modal = document.getElementById('guideModal');
        if (modal) {
            modal.classList.remove('hidden');
            // Sedikit delay agar animasi CSS transition berjalan mulus
            setTimeout(() => {
                modal.firstElementChild.classList.remove('scale-95', 'opacity-0');
                modal.firstElementChild.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
    }

    // Fungsi untuk menutup modal & simpan status ke LocalStorage
    function closeGuide() {
        const modal = document.getElementById('guideModal');
        if (modal) {
            // Animasi tutup
            modal.firstElementChild.classList.remove('scale-100', 'opacity-100');
            modal.firstElementChild.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Sesuaikan dengan durasi transition CSS

            // Set flag 'true' bahwa user sudah melihat panduan
            localStorage.setItem('realtime_guide_seen', 'true');
        }
    }

    // Cek status saat halaman dimuat
    document.addEventListener('DOMContentLoaded', () => {
        const hasSeenGuide = localStorage.getItem('realtime_guide_seen');
        
        if (hasSeenGuide !== 'true') {
            // Jika belum pernah lihat (atau value null), tampilkan modal
            showGuideModal();
        } else {
            // Jika sudah pernah ('true'), pastikan tetap hidden (default HTML hidden)
            // Tidak perlu aksi apa-apa karena class bawaan sudah hidden
        }
    });
</script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, onChildRemoved, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- DARK MODE LOGIC ---
        const html = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');

        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
        }
        
        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
        });
        
        initTheme();
        // --- END DARK MODE LOGIC ---

        const firebaseConfig = {
             apiKey: "AIzaSyBrTCPosHt9RIOpAMfxgOqCuDqJEd746lc",
             authDomain: "projects-language.firebaseapp.com",
             databaseURL: "https://projects-language-default-rtdb.firebaseio.com",
             projectId: "projects-language",
             storageBucket: "projects-language.firebasestorage.app",
             messagingSenderId: "764367056230",
             appId: "1:764367056230:web:84817b2427c435a63c2ca7",
             measurementId: "G-938GHYDMCL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentRoomId = null;
        let recognition = null;
        let isRecording = false;
        let isProcessing = false;
        
        // Listener Unsubscribe Variables (NEW: needed for refresh logic)
        let roomMsgListener = null;
        let roomRmvListener = null;

        const els = {
            loginSection: document.getElementById('loginSection'),
            dashboardSection: document.getElementById('dashboardSection'),
            chatSection: document.getElementById('chatSection'),
            settingsBar: document.getElementById('settingsBar'),
            loginBtn: document.getElementById('googleLoginBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            headerAvatar: document.getElementById('headerAvatar'),
            dashName: document.getElementById('dashName'),
            qrLoader: document.getElementById('qrLoader'),
            qrImage: document.getElementById('qrImage'),
            messages: document.getElementById('messagesContainer'),
            emptyState: document.getElementById('emptyState'),
            recordBtn: document.getElementById('recordBtn'),
            sendBtn: document.getElementById('sendBtn'),
            chatInput: document.getElementById('chatInput'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            myLang: document.getElementById('myLang'),
            targetLang: document.getElementById('targetLang')
        };

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                els.loginSection.classList.add('hidden');
                els.headerAvatar.src = user.photoURL;
                els.headerAvatar.classList.remove('hidden');
                els.logoutBtn.classList.remove('hidden'); // Show logout
                const params = new URLSearchParams(window.location.search);
                const roomParam = params.get('room');
                if (roomParam) joinRoom(roomParam);
                else initDashboard();
            } else {
                els.loginSection.classList.remove('hidden');
                els.dashboardSection.classList.add('hidden');
                els.chatSection.classList.add('hidden');
                els.settingsBar.classList.add('hidden');
                els.headerAvatar.classList.add('hidden');
                els.logoutBtn.classList.add('hidden');
                els.messages.innerHTML = '';
            }
        });

        els.loginBtn.onclick = () => signInWithPopup(auth, provider).catch(e => Swal.fire('Login Gagal', e.message, 'error'));

        // --- LOGOUT FUNCTION ---
        window.handleLogout = () => {
            Swal.fire({
                title: 'Keluar?',
                text: "Anda akan keluar dari sesi ini.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal',
                background: html.classList.contains('dark') ? '#1f2937' : '#fff',
                color: html.classList.contains('dark') ? '#f3f4f6' : '#000'
            }).then((result) => {
                if (result.isConfirmed) {
                    signOut(auth).then(() => {
                        window.location.href = '/';
                    });
                }
            });
        };
        
        // --- NEW FEATURES: REFRESH & CLEAR ---
        window.handleRefresh = () => {
            if (!currentRoomId) return;
            // Clean view
            els.messages.innerHTML = '';
            els.messages.appendChild(els.emptyState);
            els.emptyState.style.display = 'block';
            
            // Re-join (will detach old listener and attach new one)
            joinRoom(currentRoomId);
            
            // UX Feedback
            const btn = document.querySelector('button[onclick="handleRefresh()"] i');
            if(btn) {
                btn.classList.add('fa-spin');
                setTimeout(() => btn.classList.remove('fa-spin'), 1000);
            }
        };

        window.handleClear = () => {
            Swal.fire({
                title: 'Bersihkan Layar?',
                text: "Hanya menghapus tampilan chat di HP ini.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Bersihkan',
                cancelButtonText: 'Batal',
                background: html.classList.contains('dark') ? '#1f2937' : '#fff',
                color: html.classList.contains('dark') ? '#f3f4f6' : '#000'
            }).then((result) => {
                if (result.isConfirmed) {
                    els.messages.innerHTML = '';
                    els.messages.appendChild(els.emptyState);
                    els.emptyState.style.display = 'block';
                }
            });
        };

        // --- DASHBOARD ---
        async function initDashboard() {
            els.dashboardSection.classList.remove('hidden');
            els.chatSection.classList.add('hidden');
            els.dashName.textContent = `Hi, ${currentUser.displayName.split(' ')[0]}`;
            if(!currentRoomId) currentRoomId = 'RM-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            const url = `${window.location.origin}/realtime-translation?room=${currentRoomId}`;
            try {
                const res = await fetch('/api/generate-qr', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                if(data.qrImage) {
                    els.qrImage.src = data.qrImage;
                    els.qrImage.classList.remove('hidden');
                    els.qrLoader.classList.add('hidden');
                }
            } catch (e) { console.error('QR Error', e); }
        }

        window.copyRoomLink = () => {
            const url = `${window.location.origin}/realtime-translation?room=${currentRoomId}`;
            navigator.clipboard.writeText(url);
            Swal.fire({toast: true, position: 'top', icon: 'success', title: 'Link Room Disalin!', showConfirmButton: false, timer: 1500});
        }
        
        window.enterRoomSelf = () => {
            const newUrl = `${window.location.pathname}?room=${currentRoomId}`;
            window.history.pushState({path: newUrl}, '', newUrl);
            joinRoom(currentRoomId);
        };

        // --- ROOM LOGIC (Updated to support Unsubscribe) ---
        function joinRoom(id) {
            currentRoomId = id;
            els.dashboardSection.classList.add('hidden');
            els.chatSection.classList.remove('hidden');
            els.settingsBar.classList.remove('hidden');
            els.settingsBar.classList.add('grid');
            
            // Clean up previous listeners if any (for Refresh logic)
            if (roomMsgListener) roomMsgListener();
            if (roomRmvListener) roomRmvListener();
            
            // Ensure UI is clean before loading
            els.messages.innerHTML = '';
            els.messages.appendChild(els.emptyState);
            
            const roomRef = ref(db, `rooms/${id}/messages`);
            
            // Store Unsubscribe functions
            roomMsgListener = onChildAdded(roomRef, (snapshot) => {
                const msg = snapshot.val();
                if(msg) {
                    els.emptyState.style.display = 'none';
                    renderMessage(msg, snapshot.key);
                }
            });
            
            roomRmvListener = onChildRemoved(roomRef, (snapshot) => {
                const msgDiv = document.getElementById(`msg-${snapshot.key}`);
                if(msgDiv) {
                    msgDiv.remove();
                    if(els.messages.children.length <= 1) els.emptyState.style.display = 'block';
                }
            });

            initSpeechRecognition();
            initTextChat();
        }

        // --- TEXT CHAT LOGIC ---
        function initTextChat() {
            const input = els.chatInput;
            const sendBtn = els.sendBtn;
            const micBtn = els.recordBtn;

            input.addEventListener('input', function() {
                this.style.height = 'auto'; 
                this.style.height = (this.scrollHeight) + 'px';
                if(this.value.trim().length > 0) {
                    sendBtn.classList.remove('hidden');
                    micBtn.classList.add('hidden');
                } else {
                    sendBtn.classList.add('hidden');
                    micBtn.classList.remove('hidden');
                }
            });

            input.addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendTextMessage();
                }
            });

            sendBtn.addEventListener('click', sendTextMessage);
        }

        function sendTextMessage() {
            const text = els.chatInput.value.trim();
            if(!text) return;
            if(isProcessing) return;

            els.chatInput.value = '';
            els.chatInput.style.height = 'auto';
            els.sendBtn.classList.add('hidden');
            els.recordBtn.classList.remove('hidden');
            processTranslation(text);
        }

        // --- SPEECH LOGIC ---
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            recognition = new SpeechRecognition();
            recognition.continuous = false; 
            recognition.interimResults = false;
            recognition.onstart = () => { isRecording = true; updateRecordBtn(true); };
            recognition.onend = () => { isRecording = false; updateRecordBtn(false); };
            recognition.onerror = (e) => { isRecording = false; updateRecordBtn(false); };
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                if (transcript && transcript.trim().length > 0) processTranslation(transcript);
            };

            const btn = els.recordBtn;
            const startHandler = (e) => {
                e.preventDefault();
                if(isRecording || isProcessing) return;
                recognition.lang = els.myLang.value; 
                try { recognition.start(); } catch(err) {}
            };
            const stopHandler = (e) => { e.preventDefault(); if(isRecording) recognition.stop(); };
            
            btn.addEventListener('mousedown', startHandler);
            btn.addEventListener('mouseup', stopHandler);
            btn.addEventListener('touchstart', startHandler);
            btn.addEventListener('touchend', stopHandler);
        }

        function updateRecordBtn(active) {
            const btn = els.recordBtn;
            if (active) {
                btn.classList.add('bg-red-500', 'recording-pulse');
                btn.classList.remove('from-blue-600', 'to-purple-600');
            } else {
                btn.classList.remove('bg-red-500', 'recording-pulse');
                btn.classList.add('from-blue-600', 'to-purple-600');
            }
        }

        async function processTranslation(text) {
            if (!currentUser) return;
            isProcessing = true;
            els.loadingOverlay.classList.remove('hidden');
            
            const fromCode = els.myLang.value.split('-')[0];
            const toCode = els.targetLang.value;

            try {
                const res = await fetch('/api/translate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: text, fromLang: fromCode, toLang: toCode })
                });
                const data = await res.json();
                
                const payload = {
                    uid: currentUser.uid,
                    name: currentUser.displayName || "User",
                    photo: currentUser.photoURL,
                    original: text || "",
                    translated: data.translatedText || text,
                    pronunciation: data.transliteration || "",
                    fromLang: fromCode,
                    toLang: toCode,
                    timestamp: serverTimestamp()
                };
                await push(ref(db, `rooms/${currentRoomId}/messages`), payload);
            } catch (err) {
                console.error(err);
            } finally {
                isProcessing = false;
                els.loadingOverlay.classList.add('hidden');
            }
        }

        // --- RENDER LOGIC (UPDATED FOR DARK MODE) ---
        function renderMessage(msg, key) {
            const isMe = currentUser && msg.uid === currentUser.uid;
            
            let mainContent = '';
            let subContent = '';
            
            const pronHtml = msg.pronunciation ? `<div class="text-[10px] opacity-75 font-mono mt-0.5 pt-0.5 border-t border-white/10 inline-block">${msg.pronunciation}</div>` : '';

            if (isMe) {
                mainContent = `<div class="text-[15px] font-medium leading-relaxed">${msg.original}</div>`;
                subContent = `
                    <div class="mt-2 pt-1 border-t border-white/20 text-xs text-blue-50 flex flex-col gap-0.5">
                        <div class="italic opacity-90 font-medium">${msg.translated}</div>
                        ${pronHtml}
                    </div>`;
            } else {
                // Update text color for Dark mode compatibility
                mainContent = `<div class="text-[15px] font-medium leading-relaxed text-gray-800 dark:text-gray-100">${msg.translated}</div>`;
                
                subContent = `
                    <div class="mt-2 pt-1 border-t border-gray-100 dark:border-gray-600 text-xs text-gray-500 dark:text-gray-400 flex flex-col gap-0.5">
                        <div class="italic">"${msg.original}"</div>
                        ${pronHtml}
                    </div>`;
            }

            const div = document.createElement('div');
            div.id = `msg-${key}`;
            div.className = `flex gap-2 animate-fade-in mb-4 group ${isMe ? 'flex-row-reverse' : 'flex-row'}`;
            
            const deleteBtn = isMe ? `
                <button onclick="deleteMessage('${key}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-gray-300 hover:text-red-500 self-center px-2">
                    <i class="fas fa-trash-alt"></i>
                </button>` : '';

            // Update Bubble Colors for Dark Mode
            const bubbleClass = isMe 
                ? 'bg-blue-600 text-white rounded-br-none border-blue-600 shadow-blue-500/20' 
                : 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-bl-none border-gray-200 dark:border-gray-600';

            div.innerHTML = `
                <img src="${msg.photo}" class="w-8 h-8 rounded-full border border-gray-200 dark:border-gray-600 mt-auto shadow-sm object-cover bg-gray-200 dark:bg-gray-700">
                <div class="flex flex-col max-w-[85%] ${isMe ? 'items-end' : 'items-start'}">
                    <span class="text-[10px] text-gray-400 px-1 mb-0.5">${msg.name}</span>
                    <div class="px-4 py-3 rounded-2xl shadow-sm border text-sm relative transition-all ${bubbleClass}">
                        ${mainContent}
                        ${subContent}
                    </div>
                </div>
                ${deleteBtn}
            `;
            
            els.messages.appendChild(div);
            els.messages.scrollTop = els.messages.scrollHeight;
        }

        window.deleteMessage = async (key) => {
            if(!currentUser || !currentRoomId) return;
            try { await remove(ref(db, `rooms/${currentRoomId}/messages/${key}`)); } 
            catch (e) { console.error(e); }
        };
    </script>
</body>
</html>